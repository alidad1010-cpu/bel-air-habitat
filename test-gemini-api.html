<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Scanner Gemini</title>
    <style>
        body {
            font-family: system-ui;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-box {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #059669;
        }
        pre {
            background: #1a1a1a;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.ok { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.pending { background: #fef3c7; color: #92400e; }
    </style>
</head>
<body>
    <h1>üßæ Test Scanner Gemini AI</h1>
    
    <div class="test-box">
        <h2>1. V√©rification API Key</h2>
        <p>Cl√© API configur√©e : <span id="apiKeyStatus" class="status pending">V√©rification...</span></p>
        <pre id="apiKeyDisplay"></pre>
    </div>

    <div class="test-box">
        <h2>2. Test Simple (Sans Image)</h2>
        <button onclick="testSimpleAPI()">Tester API Gemini</button>
        <pre id="simpleTestResult">Cliquez pour tester...</pre>
    </div>

    <div class="test-box">
        <h2>3. Test Scanner de Ticket</h2>
        <input type="file" id="fileInput" accept="image/*,application/pdf" style="margin-bottom: 10px;">
        <br>
        <button onclick="testScanner()">Scanner le Fichier</button>
        <pre id="scannerResult">S√©lectionnez un fichier et cliquez...</pre>
    </div>

    <script type="module">
        // Configuration
        const API_KEY = 'AIzaSyAU2mW4N0fMFiEVAKxGsteOjXrNjWhk8ng';
        const MODEL = 'gemini-2.0-flash-exp';

        // Test 1: V√©rifier API Key
        const apiKeyEl = document.getElementById('apiKeyStatus');
        const apiKeyDisplay = document.getElementById('apiKeyDisplay');
        
        if (API_KEY && API_KEY.length > 20) {
            apiKeyEl.textContent = '‚úÖ Configur√©e';
            apiKeyEl.className = 'status ok';
            apiKeyDisplay.textContent = `Cl√©: ${API_KEY.substring(0, 20)}...${API_KEY.substring(API_KEY.length - 5)}`;
        } else {
            apiKeyEl.textContent = '‚ùå Manquante';
            apiKeyEl.className = 'status error';
            apiKeyDisplay.textContent = 'API Key non configur√©e !';
        }

        // Test 2: API Simple
        window.testSimpleAPI = async () => {
            const resultEl = document.getElementById('simpleTestResult');
            resultEl.textContent = 'üîÑ Test en cours...';
            
            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: 'Dis simplement "OK" si tu me re√ßois.'
                                }]
                            }]
                        })
                    }
                );

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(`HTTP ${response.status}: ${error}`);
                }

                const data = await response.json();
                resultEl.textContent = JSON.stringify(data, null, 2);
                resultEl.style.color = '#10b981';
            } catch (error) {
                resultEl.textContent = `‚ùå Erreur:\n${error.message}\n\nD√©tails:\n${error.stack}`;
                resultEl.style.color = '#ef4444';
            }
        };

        // Test 3: Scanner
        window.testScanner = async () => {
            const fileInput = document.getElementById('fileInput');
            const resultEl = document.getElementById('scannerResult');
            
            const file = fileInput.files?.[0];
            if (!file) {
                resultEl.textContent = '‚ùå Veuillez s√©lectionner un fichier d\'abord !';
                return;
            }

            resultEl.textContent = `üîÑ Analyse de ${file.name} (${(file.size / 1024).toFixed(1)} KB)...\n\nCela peut prendre 5-15 secondes...`;

            try {
                // Convertir en base64
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const result = reader.result;
                        const base64Data = result.split(',')[1];
                        resolve(base64Data);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                // Appel API
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    {
                                        inline_data: {
                                            mime_type: file.type,
                                            data: base64
                                        }
                                    },
                                    {
                                        text: `Agis comme un expert comptable. Analyse ce document (Ticket ou Facture).
Extrais les donn√©es au format JSON uniquement.

Champs requis :
- docType: "Ticket" ou "Facture"
- date: Date au format YYYY-MM-DD
- merchant: Nom du commer√ßant
- amount: Montant total TTC (num√©rique)
- vat: Montant TVA (num√©rique, optionnel)
- category: Cat√©gorie (Carburant, Restaurant, Mat√©riel, Loyer, Assurances, Autre)

R√©ponds UNIQUEMENT avec le JSON valide, sans markdown.
Exemple: {"docType":"Ticket","date":"2026-01-16","merchant":"Carrefour","amount":45.67,"vat":null,"category":"Restaurant"}`
                                    }
                                ]
                            }]
                        })
                    }
                );

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(`HTTP ${response.status}: ${error}`);
                }

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!text) {
                    throw new Error('Aucune r√©ponse de l\'IA');
                }

                // Parser JSON
                let cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const parsed = JSON.parse(cleanText);

                resultEl.textContent = `‚úÖ Extraction r√©ussie !\n\nDonn√©es extraites:\n${JSON.stringify(parsed, null, 2)}\n\nR√©ponse brute de l'IA:\n${text}`;
                resultEl.style.color = '#10b981';
            } catch (error) {
                resultEl.textContent = `‚ùå Erreur lors de l'analyse:\n\n${error.message}\n\nD√©tails:\n${error.stack}`;
                resultEl.style.color = '#ef4444';
            }
        };
    </script>
</body>
</html>
